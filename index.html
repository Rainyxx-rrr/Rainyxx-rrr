

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>EVE Studio - v12.3 DecoFix</title>
    <style>
        :root { 
            --bg-body: #f4f6f9; 
            --bg-panel: #ffffff; 
            --primary: #0066CC; 
            --text-main: #333333;
            --text-sub: #666666;
            --border: #e6e6e6;
            --danger: #ff4d4f;
            --safe-bottom: env(safe-area-inset-bottom, 20px);
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Arial, sans-serif; 
            background: var(--bg-body); 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            margin: 0; 
            color: var(--text-main);
            font-size: 13px;
            overflow: hidden; 
        }

        .container { 
            display: flex; 
            gap: 20px; 
            width: 96%; 
            max-width: 1400px; 
            height: 92vh; 
            padding-bottom: 20px;
        }

        @media (max-width: 900px) {
            body { height: 100vh; padding: 0; display: block; position: fixed; width: 100%; }
            .container { flex-direction: column; height: 100%; width: 100%; padding: 0; gap: 0; }
            .preview-area { 
                height: 35vh; order: -1; border-radius: 0 0 20px 20px !important; z-index: 10;
                box-shadow: 0 4px 10px rgba(0,0,0,0.05); transition: height 0.3s ease;
            }
            .panel { 
                width: 100% !important; flex: 1; border-radius: 20px 20px 0 0 !important; 
                border: none !important; box-shadow: 0 -4px 20px rgba(0,0,0,0.05) !important;
                z-index: 20; padding-bottom: calc(var(--safe-bottom) + 60px) !important;
            }
            body.sim-mode .preview-area { height: 75vh; }
            body.sim-mode .panel { flex: 0 0 25vh; }
        }

        .panel { 
            width: 440px; background: var(--bg-panel); border-radius: 16px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.04); display: flex; flex-direction: column; 
            overflow: hidden; border: 1px solid rgba(0,0,0,0.06);
        }

        .tab-header { 
            display: flex; background: #fcfcfc; border-bottom: 1px solid var(--border);
            padding: 0 5px; height: 48px; align-items: center; flex-shrink: 0;
        }
        .tab-scroll-area { flex: 1; display: flex; overflow-x: auto; height: 100%; scrollbar-width: none; }
        .tab-btn { 
            padding: 0 16px; border: none; background: none; cursor: pointer; 
            font-size: 13px; font-weight: 500; color: var(--text-sub); white-space: nowrap; 
            height: 100%; border-bottom: 2px solid transparent; flex-shrink: 0;
        }
        .tab-btn.active { color: var(--primary); font-weight: 600; border-bottom-color: var(--primary); background: #fff; }
        .reset-btn {
            padding: 0 15px; height: 100%; border: none; background: none; 
            cursor: pointer; font-size: 12px; font-weight: 600; color: var(--danger); 
            border-left: 1px solid var(--border); white-space: nowrap; flex-shrink: 0;
        }

        .tab-content { padding: 24px; overflow-y: auto; flex: 1; display: none; -webkit-overflow-scrolling: touch; }
        .tab-content.active { display: block; }

        h2 { font-size: 15px; margin: 0 0 16px; font-weight: 700; color: #000; }
        
        .preset-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 24px; }
        .preset-item { 
            padding: 10px; border: 1px solid var(--border); border-radius: 8px; background: #fff; 
            cursor: pointer; text-align: center; color: #555;
        }
        .preset-item:hover { border-color: var(--primary); color: var(--primary); background: #f0f7ff; }
        
        .control-group { margin-bottom: 22px; position: relative; }
        .label-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .label-text { font-size: 12px; font-weight: 600; color: #444; }
        .label-val { font-family: 'Menlo', monospace; font-size: 11px; color: var(--primary); background: #f2f2f7; padding: 2px 6px; border-radius: 4px; }
        
        input[type="range"] { width: 100%; height: 4px; border-radius: 2px; background: #e0e0e0; -webkit-appearance: none; margin: 8px 0; display: block;}
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 18px; height: 18px; border-radius: 50%; background: #fff; border: 2px solid var(--primary); cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }

        .color-row { display: flex; gap: 8px; margin-top: 10px; }
        .color-wrapper { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 6px; }
        input[type="color"] { width: 100%; height: 36px; border: 1px solid var(--border); border-radius: 50px; cursor: pointer; background: none; padding: 0; }
        .hex-input {
            width: 100%; border: none; background: transparent; 
            font-family: 'Menlo', monospace; font-size: 10px; color: #888;
            text-align: center; padding: 4px 0; border-radius: 4px;
        }
        .hex-input:focus { background: #fff; color: #000; outline: 1px solid var(--primary); }
        input[type="range"].mini-alpha { margin: 2px 0 0; height: 3px; }
        select { width: 100%; padding: 8px; border-radius: 6px; border: 1px solid var(--border); background: #fff; font-size: 12px; color: #333; margin-top: 5px; }
        input[type="checkbox"] { accent-color: var(--primary); width: 16px; height: 16px; }

        .num-input {
            width: 50px; border: 1px solid #ddd; background: #fff; 
            border-radius: 4px; padding: 2px 4px; font-family: 'Menlo', monospace;
            font-size: 11px; text-align: center; color: var(--primary);
        }
        .num-input:focus { outline: 1px solid var(--primary); border-color: var(--primary); }

        /* Decoration Layer List */
        .layer-list { display: flex; flex-direction: column; gap: 10px; margin-top: 15px; }
        .layer-item { 
            background: #f9f9fa; border: 1px solid #eee; border-radius: 8px; padding: 12px; 
            display: flex; flex-direction: column; gap: 8px; position: relative;
        }
        .layer-header { display: flex; justify-content: space-between; align-items: center; }
        .layer-title { font-weight: 600; font-size: 12px; color: #555; }
        .layer-remove { color: #ff4d4f; cursor: pointer; font-size: 11px; padding: 2px 6px; border: 1px solid #ff4d4f; border-radius: 4px; }
        .add-layer-btn { 
            width: 100%; padding: 10px; border: 1px dashed #ccc; background: #fff; 
            color: #666; border-radius: 8px; cursor: pointer; margin-top: 10px; font-size: 12px;
        }
        .add-layer-btn:hover { border-color: var(--primary); color: var(--primary); background: #f0f7ff; }

        .preview-area { 
            flex: 1; background: #e5e5f7 radial-gradient(#ccc 1px, transparent 1px); 
            background-size: 20px 20px; border-radius: 16px; display: flex; flex-direction: column;
            position: relative; overflow: hidden; border: 1px solid rgba(0,0,0,0.06);
        }

        .canvas-toolbar {
            background: #fff; border-bottom: 1px solid var(--border); padding: 8px;
            display: flex; justify-content: center; gap: 8px; z-index: 20; flex-shrink: 0;
        }
        @media (min-width: 901px) {
            .canvas-toolbar { position: absolute; top: 16px; right: 16px; border-radius: 8px; box-shadow: 0 2px 12px rgba(0,0,0,0.08); border: none; padding: 6px; }
        }
        .toolbar-btn {
            background: transparent; border: 1px solid transparent; padding: 6px 12px;
            font-size: 12px; font-weight: 500; color: #666; cursor: pointer; border-radius: 6px;
        }
        .toolbar-btn.active { background: #333; color: #fff; }

        .preview-stage {
            flex: 1; display: flex; align-items: center; justify-content: center;
            padding: 20px; overflow-y: auto; width: 100%; -webkit-overflow-scrolling: touch;
        }

        .preview-bubble {
            position: relative; max-width: 400px; padding: 10px 12px; 
            font-size: 15px; line-height: 1.55; letter-spacing: 0.02em; z-index: 10;
            display: inline-block; text-align: left; word-break: break-word; box-sizing: border-box;
            -webkit-backdrop-filter: blur(var(--blur-val)); backdrop-filter: blur(var(--blur-val));
            outline-style: solid; 
        }

        .chat-container { width: 100%; max-width: 500px; display: flex; flex-direction: column; gap: 18px; padding-bottom: 40px; }
        .chat-row { display: flex; align-items: flex-start; gap: 10px; width: 100%; }
        .chat-row.right { flex-direction: row-reverse; }
        .chat-avatar { width: 2.5rem; height: 2.5rem; background: #ddd; border-radius: 6px; flex-shrink: 0; background-size: cover; background-position: center; }
        .chat-bubble-gray {
            background: #ffffff; padding: 11px 15px; border-radius: 4px 14px 14px 14px;
            font-size: 15px; line-height: 1.55; color: #333; max-width: 75%; 
            position: relative; border: 1px solid #eee; box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .role-switcher { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 20px; }
        .role-btn { padding: 12px; border: 1px solid var(--border); background: #f9f9f9; border-radius: 8px; font-size: 12px; cursor: pointer; color: #666; }
        .role-btn.active { background: #e6f0ff; border-color: var(--primary); color: var(--primary); font-weight: 600; }

        .code-box {
            width: 100%; background: #1e1e1e; color: #a9b7c6; padding: 16px;
            border-radius: 8px; font-family: 'Menlo', monospace; font-size: 11px;
            line-height: 1.5; white-space: pre-wrap; border: 1px solid #333; margin-top: 12px;
        }
        .copy-btn-main {
            width: 100%; padding: 14px; background: var(--primary); color: #fff;
            border: none; border-radius: 8px; font-weight: 600; cursor: pointer; margin-top: 5px;
        }

        .grad-pad {
            width: 100%; height: 100px; background: #fff; border: 1px solid var(--border);
            border-radius: 8px; position: relative; cursor: crosshair; margin: 10px 0;
            overflow: hidden;
            background-image: linear-gradient(45deg, #eee 25%, transparent 25%, transparent 75%, #eee 75%, #eee), linear-gradient(45deg, #eee 25%, transparent 25%, transparent 75%, #eee 75%, #eee);
            background-size: 16px 16px; background-position: 0 0, 8px 8px;
        }
        .grad-point { width: 14px; height: 14px; background: var(--primary); border: 2px solid #fff; border-radius: 50%; position: absolute; pointer-events: none; transform: translate(-50%, -50%); box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .grad-line { position: absolute; top: 50%; left: 50%; width: 100%; height: 2px; background: var(--primary); opacity: 0.2; transform-origin: 0 50%; pointer-events: none; }

        .creator-watermark {
            position: fixed; bottom: 20px; right: 25px; text-align: right;
            font-family: -apple-system, sans-serif; z-index: 9999; pointer-events: none; opacity: 0.6;
            transition: opacity 0.3s;
        }
        .creator-watermark:hover { opacity: 1; }
        .creator-watermark span { font-size: 12px; color: #86868b; font-weight: 500; }
        .creator-watermark strong { color: #007AFF; font-weight: 700; }
        .creator-watermark .divider { margin: 0 6px; opacity: 0.4; }
        .creator-watermark .license-note { font-size: 10px; color: #ff3b30; margin-top: 2px; opacity: 0.7; letter-spacing: 0.5px; }
        @media (max-width: 900px) {
            .creator-watermark { bottom: calc(var(--safe-bottom) + 15px); right: 15px; background: rgba(255,255,255,0.8); padding: 6px 12px; border-radius: 8px; backdrop-filter: blur(5px); box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        }
        
        .warn-box {
            font-size: 11px; color: #856404; background-color: #fff3cd; 
            border: 1px solid #ffeeba; padding: 8px; border-radius: 6px; margin-top: 8px;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="panel">
        <div class="tab-header">
            <div class="tab-scroll-area">
                <button class="tab-btn active" onclick="switchTab(0)">å¤–è§‚</button>
                <button class="tab-btn" onclick="switchTab(1)">è´¨æ„Ÿ</button>
                <button class="tab-btn" onclick="switchTab(2)">è’™ç‰ˆ</button>
                <button class="tab-btn" onclick="switchTab(3)">è´´å›¾</button>
                <button class="tab-btn" onclick="switchTab(6)">è£…é¥°</button>
                <button class="tab-btn" onclick="switchTab(4)">æ¨¡æ‹Ÿ</button>
                <button class="tab-btn" onclick="switchTab(5)">å¯¼å‡º</button>
            </div>
            <button class="reset-btn" onclick="resetMemory()" title="æ¢å¤é»˜è®¤è®¾ç½®">é‡ç½®</button>
        </div>

        <!-- Tab 0: å¤–è§‚ -->
        <div class="tab-content active" id="tab0">
            <h2>é£æ ¼é¢„è®¾</h2>
            <div class="preset-grid">
                <div class="preset-item" onclick="applyPreset('classic')">ç»å…¸çº¯ç™½</div>
                <div class="preset-item" onclick="applyPreset('glass')">ç£¨ç ‚ç»ç’ƒ</div>
                <div class="preset-item" onclick="applyPreset('raindrop')">ç«‹ä½“é›¨æ»´</div>
                <div class="preset-item" onclick="applyPreset('pearl')">åœ†æ¶¦çç </div>
                <div class="preset-item" onclick="applyPreset('gradient')">æ¢¦å¹»æ¸å˜</div>
                <div class="preset-item" onclick="applyPreset('dark')">æå®¢æ·±è‰²</div>
                <div class="preset-item special" onclick="applyPreset('custom')">è‡ªç”±åˆ›ä½œ</div>
            </div>

            <div class="control-group">
                <div class="label-row"><span class="label-text">èƒŒæ™¯é¢œè‰² (é¢œè‰²çƒ + ç‹¬ç«‹é€æ˜åº¦)</span></div>
                <select id="gradType" class="save-state" onchange="update()">
                    <option value="linear">çº¿æ€§æ¸å˜</option>
                    <option value="radial">å¾„å‘æ¸å˜ (å…‰æº)</option>
                    <option value="none">çº¯è‰²å¡«å……</option>
                </select>
                <div class="grad-pad" id="gradPad">
                    <div class="grad-line" id="gradLine"></div>
                    <div class="grad-point" id="gradPoint" style="left:70%; top:80%;"></div>
                </div>
                <select id="colorCount" class="save-state" onchange="update()" style="margin-top:10px">
                    <option value="1">å•è‰²</option>
                    <option value="2" selected>åŒè‰²èåˆ</option>
                    <option value="3">ä¸‰è‰²</option>
                    <option value="4">å››è‰²</option>
                </select>
                <div class="color-row">
                    <div class="color-wrapper">
                        <input type="color" id="c1" class="color-in save-state" value="#ffffff" oninput="syncColor('c1', 'h1'); update()">
                        <input type="text" id="h1" class="hex-input" value="#ffffff" onchange="syncHex('h1', 'c1'); update()">
                        <input type="range" id="a1" class="mini-alpha alpha-in save-state" min="0" max="1" step="0.01" value="1" oninput="update()">
                    </div>
                    <div class="color-wrapper">
                        <input type="color" id="c2" class="color-in save-state" value="#74ebd5" oninput="syncColor('c2', 'h2'); update()">
                        <input type="text" id="h2" class="hex-input" value="#74ebd5" onchange="syncHex('h2', 'c2'); update()">
                        <input type="range" id="a2" class="mini-alpha alpha-in save-state" min="0" max="1" step="0.01" value="1" oninput="update()">
                    </div>
                    <div class="color-wrapper">
                        <input type="color" id="c3" class="color-in save-state" value="#acb6e5" oninput="syncColor('c3', 'h3'); update()">
                        <input type="text" id="h3" class="hex-input" value="#acb6e5" onchange="syncHex('h3', 'c3'); update()">
                        <input type="range" id="a3" class="mini-alpha alpha-in save-state" min="0" max="1" step="0.01" value="1" oninput="update()">
                    </div>
                    <div class="color-wrapper">
                        <input type="color" id="c4" class="color-in save-state" value="#2c3e50" oninput="syncColor('c4', 'h4'); update()">
                        <input type="text" id="h4" class="hex-input" value="#2c3e50" onchange="syncHex('h4', 'c4'); update()">
                        <input type="range" id="a4" class="mini-alpha alpha-in save-state" min="0" max="1" step="0.01" value="1" oninput="update()">
                    </div>
                </div>
            </div>

            <div class="control-group">
                <div class="label-row"><span class="label-text">æ–‡å­—æ ·å¼</span></div>
                <div style="display:flex; gap:12px;">
                    <div class="color-wrapper" style="flex:1">
                        <input type="color" id="customFontColor" class="save-state" value="#444444" oninput="syncColor('customFontColor', 'fontHex'); toggleAutoColor(false); update()">
                        <input type="text" id="fontHex" class="hex-input" value="#444444" onchange="syncHex('fontHex', 'customFontColor'); toggleAutoColor(false); update()">
                    </div>
                    <div style="flex:2; display:flex; flex-direction:column; justify-content:center;">
                        <input type="range" id="fontAlpha" class="mini-alpha save-state" min="0" max="1" step="0.01" value="1" oninput="toggleAutoColor(false); update()" title="æ–‡å­—é€æ˜åº¦">
                        <label style="font-size:12px; display:flex; align-items:center; margin-top:8px; color:#555;">
                            <input type="checkbox" id="autoColorSwitch" class="save-state" checked onchange="update()"> è‡ªåŠ¨åè‰²
                        </label>
                    </div>
                </div>
            </div>
            
            <div class="control-group">
                <div class="label-row"><span class="label-text">æ•´ä½“ä¸é€æ˜åº¦</span><span class="label-val" id="val-alpha">1.0</span></div>
                <input type="range" id="alpha" class="save-state" min="0" max="1" step="0.01" value="1" oninput="syncGlobalAlpha(); update()">
            </div>
        </div>

        <!-- Tab 1: è´¨æ„Ÿ -->
        <div class="tab-content" id="tab1">
            <div class="control-group">
                <div class="label-row"><span class="label-text">å°ºå¯¸é™åˆ¶</span></div>
                <div class="label-row"><span class="label-text" style="font-weight:400; font-size:11px;">æœ€å¤§å®½åº¦ (% of screen)</span><span class="label-val" id="val-maxWidth">80</span></div>
                <input type="range" id="maxWidth" class="save-state" min="30" max="100" value="80" oninput="update()">
                
                <div style="display:flex; gap:10px; margin-top:10px;">
                    <div style="flex:1">
                        <div class="label-row"><small>æœ€å°å®½åº¦ (px)</small></div>
                        <input type="range" id="minWidth" class="save-state" min="0" max="200" value="20" oninput="update()">
                    </div>
                    <div style="flex:1">
                        <div class="label-row"><small>æœ€å°é«˜åº¦ (px)</small></div>
                        <input type="range" id="minHeight" class="save-state" min="0" max="100" value="20" oninput="update()">
                    </div>
                </div>
            </div>

            <div class="control-group">
                <div class="label-row">
                    <span class="label-text">å†…è¾¹è· (Padding)</span>
                    <label style="font-size:11px; display:flex; align-items:center;">
                        <input type="checkbox" id="padLock" class="save-state" checked onchange="togglePadLock()"> é”å®šå¯¹ç§°
                    </label>
                </div>

                <!-- å¯¹ç§°æ¨¡å¼ (é»˜è®¤æ˜¾ç¤º) -->
                <div id="pad-symmetric">
                     <div class="label-row"><small>å‚ç›´ (ä¸Šä¸‹)</small><span class="label-val" id="val-pady">10</span></div>
                     <input type="range" id="pady" class="save-state" min="0" max="60" value="10" oninput="updatePad('y')">
                     <div class="label-row"><small>æ°´å¹³ (å·¦å³)</small><span class="label-val" id="val-padx">12</span></div>
                     <input type="range" id="padx" class="save-state" min="0" max="80" value="12" oninput="updatePad('x')">
                </div>

                <!-- ç‹¬ç«‹æ¨¡å¼ (éšè—) -->
                <div id="pad-independent" style="display:none; grid-template-columns: 1fr 1fr; gap:10px; margin-top:5px;">
                     <div>
                         <div class="label-row" style="margin-bottom:0;"><small>ä¸Š (Top)</small><span class="label-val" style="font-size:9px" id="val-pt">10</span></div>
                         <input type="range" id="pt" class="save-state" min="0" max="60" value="10" oninput="update()">
                     </div>
                     <div>
                         <div class="label-row" style="margin-bottom:0;"><small>ä¸‹ (Bottom)</small><span class="label-val" style="font-size:9px" id="val-pb">10</span></div>
                         <input type="range" id="pb" class="save-state" min="0" max="60" value="10" oninput="update()">
                     </div>
                     <div>
                         <div class="label-row" style="margin-bottom:0;"><small>å·¦ (Left)</small><span class="label-val" style="font-size:9px" id="val-pl">12</span></div>
                         <input type="range" id="pl" class="save-state" min="0" max="80" value="12" oninput="update()">
                     </div>
                     <div>
                         <div class="label-row" style="margin-bottom:0;"><small>å³ (Right)</small><span class="label-val" style="font-size:9px" id="val-pr">12</span></div>
                         <input type="range" id="pr" class="save-state" min="0" max="80" value="12" oninput="update()">
                     </div>
                </div>
            </div>

            <div class="control-group">
                <div class="label-row">
                    <span class="label-text">æ°”æ³¡å½¢çŠ¶ (å››è§’ç‹¬ç«‹æ§åˆ¶)</span>
                    <label style="font-size:11px; display:flex; align-items:center;">
                        <input type="checkbox" id="lockCorners" class="save-state" checked onchange="updateLock()"> é”å®š
                    </label>
                </div>
                <div id="unifiedRadiusControl">
                    <input type="range" id="radius" class="save-state" min="0" max="60" value="18" oninput="update()">
                </div>
                <div id="cornerControls" style="display:none; grid-template-columns: 1fr 1fr; gap:12px;">
                    <div><small>å·¦ä¸Š</small><input type="range" id="r_tl" class="save-state" min="0" max="60" value="18" oninput="update()"></div>
                    <div><small>å³ä¸Š</small><input type="range" id="r_tr" class="save-state" min="0" max="60" value="18" oninput="update()"></div>
                    <div><small>å·¦ä¸‹</small><input type="range" id="r_bl" class="save-state" min="0" max="60" value="18" oninput="update()"></div>
                    <div><small>å³ä¸‹</small><input type="range" id="r_br" class="save-state" min="0" max="60" value="18" oninput="update()"></div>
                </div>
            </div>

            <!-- ä¸»è¾¹æ¡† -->
            <div class="control-group">
                <div class="label-row">
                    <span class="label-text">è¾¹æ¡† 1 (ä¸»è¦) - Outline</span>
                    <label style="font-size:11px; color:#555;"><input type="checkbox" id="gradBorderSwitch" class="save-state" onchange="update()"> å¯ç”¨æµå…‰è¾¹æ¡†(Mask)</label>
                </div>
                
                <div id="stdBorderControls" class="color-row">
                    <div class="color-wrapper">
                        <input type="color" id="borderColorPicker" class="save-state" value="#cfcfcf" oninput="syncColor('borderColorPicker','borderHex'); update()">
                        <input type="text" id="borderHex" class="hex-input" value="#cfcfcf" onchange="syncHex('borderHex','borderColorPicker'); update()">
                    </div>
                    <div style="flex:3; display:flex; flex-direction:column; justify-content:center;">
                        <small style="color:#888; font-size:10px;">é€æ˜åº¦</small>
                        <input type="range" id="borderAlpha" class="save-state" min="0" max="1" step="0.01" value="1" oninput="update()">
                    </div>
                </div>

                <div id="gradBorderControls" style="display:none; flex-direction:column; gap:10px;">
                    <div style="font-size:10px; color:#d93025; background:#fff0f0; padding:6px; border-radius:4px;">âš ï¸ æµå…‰è¾¹æ¡†å ç”¨ ::beforeï¼Œè¾…åŠ©è´´å›¾å°†è¢«ç¦ç”¨ã€‚</div>
                    <div class="color-row">
                        <div class="color-wrapper">
                            <input type="color" id="gbC1" class="save-state" value="#00c6ff" oninput="syncColor('gbC1','gh1'); update()">
                            <input type="text" id="gh1" class="hex-input" value="#00c6ff" onchange="syncHex('gh1','gbC1'); update()">
                            <input type="range" id="gbA1" class="mini-alpha save-state" min="0" max="1" step="0.01" value="1" oninput="update()">
                        </div>
                        <div class="color-wrapper">
                            <input type="color" id="gbC2" class="save-state" value="#0072ff" oninput="syncColor('gbC2','gh2'); update()">
                            <input type="text" id="gh2" class="hex-input" value="#0072ff" onchange="syncHex('gh2','gbC2'); update()">
                            <input type="range" id="gbA2" class="mini-alpha save-state" min="0" max="1" step="0.01" value="1" oninput="update()">
                        </div>
                    </div>
                    <div class="label-row"><span class="label-text">æµå…‰è§’åº¦</span></div>
                    <input type="range" id="gbAngle" class="save-state" min="0" max="360" value="45" oninput="update()">
                </div>

                <div style="margin-top:12px;">
                    <div class="label-row"><span class="label-text">ç²—ç»†</span><span class="label-val" id="val-bwidth">1.5</span></div>
                    <input type="range" id="bwidth" class="save-state" min="0" max="12" step="0.5" value="1.5" oninput="update()">
                </div>
                <div class="label-row" style="margin-top:10px;"><span class="label-text">æ ·å¼ (æ”¯æŒåç§»)</span><span class="label-val" id="val-boffset">-6</span></div>
                <div style="display:flex; gap:10px;">
                    <select id="borderStyle" class="save-state" onchange="update()" style="flex:1; margin-top:0;">
                        <option value="solid">å®çº¿</option>
                        <option value="dashed">è™šçº¿</option>
                        <option value="dotted">ç‚¹çŠ¶</option>
                        <option value="double">åŒçº¿</option>
                    </select>
                    <input type="range" id="boffset" class="save-state" min="-20" max="20" value="-6" step="1" oninput="update()" style="flex:1; margin:0;" title="åç§»">
                </div>
            </div>

            <!-- ç¬¬äºŒè¾¹æ¡† (New) -->
            <div class="control-group">
                <div class="label-row">
                    <span class="label-text">è¾¹æ¡† 2 (æ¬¡è¦) - Border</span>
                    <label style="font-size:11px; color:#555;"><input type="checkbox" id="b2Switch" class="save-state" onchange="update()"> å¯ç”¨</label>
                </div>
                <div id="b2Controls" style="display:none; background:#f5f5f7; padding:10px; border-radius:8px;">
                     <div class="color-row">
                        <div class="color-wrapper">
                            <input type="color" id="b2ColorPicker" class="save-state" value="#ff0000" oninput="syncColor('b2ColorPicker','b2Hex'); update()">
                            <input type="text" id="b2Hex" class="hex-input" value="#ff0000" onchange="syncHex('b2Hex','b2ColorPicker'); update()">
                        </div>
                        <div style="flex:3; display:flex; flex-direction:column; justify-content:center;">
                            <small style="color:#888; font-size:10px;">é€æ˜åº¦</small>
                            <input type="range" id="b2Alpha" class="save-state" min="0" max="1" step="0.01" value="1" oninput="update()">
                        </div>
                    </div>
                    <div style="margin-top:10px;">
                        <div class="label-row"><span class="label-text">å®½åº¦</span><span class="label-val" id="val-b2width">2</span></div>
                        <input type="range" id="b2Width" class="save-state" min="0" max="20" step="0.5" value="2" oninput="update()">
                    </div>
                    <div style="margin-top:10px;">
                         <div class="label-row"><span class="label-text">æ ·å¼</span></div>
                         <select id="b2Style" class="save-state" onchange="update()">
                             <option value="solid">å®çº¿</option>
                             <option value="dashed">è™šçº¿ (Dashed)</option>
                             <option value="dotted">ç‚¹çŠ¶ (Dotted)</option>
                             <option value="double">åŒçº¿ (Double)</option>
                         </select>
                         <div class="warn-box">
                             æ­¤è¾¹æ¡†ä¸ºå†…ç¯(Native Border)ï¼Œä¸æ”¯æŒè‡ªç”±åç§»ï¼Œç´§è´´æ°”æ³¡è¾¹ç¼˜ã€‚å¦‚éœ€åç§»å…‰ç¯è¯·ä½¿ç”¨"è¾¹æ¡†1"ã€‚
                         </div>
                    </div>
                </div>
            </div>

            <div class="control-group">
                <div class="label-row"><span class="label-text">éœ“è™¹é˜´å½±</span></div>
                <div class="color-row">
                    <div class="color-wrapper">
                        <input type="color" id="shadowColor" class="save-state" value="#000000" oninput="syncColor('shadowColor','sh1'); update()">
                        <input type="text" id="sh1" class="hex-input" value="#000000" onchange="syncHex('sh1','shadowColor'); update()">
                    </div>
                    <div style="flex:3; display:flex; align-items:center;">
                        <input type="range" id="shadowAlpha" class="save-state" min="0" max="1" step="0.01" value="0.18" oninput="update()">
                    </div>
                </div>
                <div class="label-row" style="margin-top:8px;"><span class="label-text">æ‰©æ•£å¤§å°</span><span class="label-val" id="val-shadow">12</span></div>
                <input type="range" id="shadow" class="save-state" min="0" max="80" value="12" oninput="update()">
            </div>

            <div class="control-group">
                <div class="label-row"><span class="label-text">èƒŒæ™¯æ¨¡ç³Š (Blur)</span><span class="label-val" id="val-blur">0</span></div>
                <input type="range" id="blur" class="save-state" min="0" max="40" value="0" oninput="update()">
                <div class="label-row" style="margin-top:10px;"><span class="label-text">å†…å‘å…‰åšåº¦</span><span class="label-val" id="val-inset">15</span></div>
                <input type="range" id="inset" class="save-state" min="0" max="60" value="15" oninput="update()">
            </div>
        </div>

        <!-- Tab 2: è’™ç‰ˆ (åº•çº¹+æ‰«å…‰) -->
        <div class="tab-content" id="tab2">
            <div class="control-group">
                <div class="label-row">
                    <span class="label-text">è¡¨é¢æ‰«å…‰ (Sheen)</span>
                    <input type="checkbox" id="sheenSwitch" class="save-state" onchange="update()">
                </div>
                <div id="sheenControls" style="display:none;">
                    <div class="color-row">
                        <div class="color-wrapper">
                            <input type="color" id="sheenColor" class="save-state" value="#ffffff" oninput="syncColor('sheenColor','sheenHex'); update()">
                            <input type="text" id="sheenHex" class="hex-input" value="#ffffff" onchange="syncHex('sheenHex','sheenColor'); update()">
                        </div>
                        <div style="flex:3">
                            <div class="label-row"><span class="label-text">å®½åº¦</span><span class="label-val" id="val-sheenW">25</span></div>
                            <input type="range" id="sheenWidth" class="save-state" min="1" max="100" value="25" oninput="update()">
                        </div>
                    </div>
                    <div class="label-row" style="margin-top:10px;"><span class="label-text">å¼ºåº¦</span></div>
                    <input type="range" id="sheenOp" class="save-state" min="0" max="1" step="0.05" value="0.6" oninput="update()">
                    <div class="label-row"><span class="label-text">ä½ç½®</span></div>
                    <input type="range" id="sheenPos" class="save-state" min="0" max="100" value="50" oninput="update()">
                    <div class="label-row"><span class="label-text">è§’åº¦</span></div>
                    <input type="range" id="sheenAngle" class="save-state" min="0" max="360" value="135" oninput="update()">
                </div>
            </div>

            <div class="control-group">
                <div class="label-text" style="margin-bottom:8px;">ä¸Šä¼ æ°”æ³¡åº•çº¹ (Skin)</div>
                <input type="file" onchange="uploadImg(this, 'bg')" style="font-size:12px;">
                <div class="warn-box" style="margin-top:10px;">
                    <strong>ä¿®å¤è¯´æ˜ï¼š</strong> å·²ç§»é™¤å¯èƒ½å¯¼è‡´"å˜ç»¿"çš„è’™ç‰ˆé€»è¾‘ã€‚ç°åœ¨ç›´æ¥ä½œä¸ºèƒŒæ™¯å±‚æ¸²æŸ“ã€‚å¦‚éœ€åŠé€æ˜ï¼Œè¯·ç›´æ¥ä¸Šä¼ PNGå›¾ç‰‡æˆ–ä½¿ç”¨ä¸‹æ–¹æ··åˆæ¨¡å¼ã€‚
                </div>
                <div style="margin-top:15px;">
                    <div class="label-text" style="margin-bottom:5px;">æˆ–è¾“å…¥å›¾ç‰‡ URL</div>
                    <div style="display:flex; gap:5px;">
                        <input type="text" id="bgUrlInput" placeholder="https://..." style="flex:1; padding:8px; border:1px solid #ddd; border-radius:4px; font-size:12px;">
                        <button onclick="applyBgUrl()" style="border:1px solid #ddd; background:#f5f5f7; border-radius:4px; cursor:pointer; font-size:12px; padding:0 12px;">åº”ç”¨</button>
                    </div>
                </div>

                <!-- åº•çº¹æ··åˆæ¨¡å¼ -->
                <div style="margin-top:20px; padding:15px; background:#f9f9fa; border-radius:8px; border:1px solid #eee;">
                    <div class="label-row"><span class="label-text">æ··åˆæ¨¡å¼ (Blend Mode)</span></div>
                    <select id="bgBlend" class="save-state" onchange="update()">
                        <option value="normal">æ­£å¸¸ (Normal)</option>
                        <option value="overlay">å åŠ  (Overlay)</option>
                        <option value="screen">æ»¤è‰² (Screen)</option>
                        <option value="multiply">æ­£ç‰‡å åº• (Multiply)</option>
                        <option value="soft-light">æŸ”å…‰ (Soft Light)</option>
                        <option value="luminosity">æ˜åº¦ (Luminosity)</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Tab 3: è´´å›¾ (åŒè´´å›¾ + é€æ˜åº¦ + ç²¾å‡†å¾®è°ƒ + å¤šé”šç‚¹) -->
        <div class="tab-content" id="tab3">
            <!-- è´´å›¾1 (After) -->
            <div class="control-group" style="padding-bottom:20px; border-bottom:1px dashed #eee;">
                <div class="label-row">
                    <span class="label-text">è´´å›¾ 1 (::after) - ä¸»åŠ›æ¨è</span>
                    <label style="font-size:11px; color:#555;">
                        <input type="checkbox" id="sticker1Switch" class="save-state" onchange="update()"> å¯ç”¨
                    </label>
                </div>
                <div id="sticker1Controls" style="display:none; background:#f9f9fa; padding:10px; border-radius:8px; margin-top:10px;">
                    <div class="label-text" style="margin-bottom:6px;">ä¸Šä¼ æˆ–è¾“å…¥URL</div>
                    <input type="file" onchange="uploadImg(this, 'sticker1')" style="font-size:12px; width:100%; margin-bottom:5px;">
                    <div style="display:flex; gap:6px;">
                        <input type="text" id="sticker1UrlInput" placeholder="http://..." style="flex:1; padding:6px; border:1px solid #ddd; border-radius:4px; font-size:12px;">
                        <button onclick="applyStickerUrl(1)" style="border:1px solid #ddd; background:#fff; border-radius:4px; cursor:pointer; font-size:12px; padding:0 10px;">åº”ç”¨</button>
                    </div>

                    <div class="label-row" style="margin-top:10px;"><span class="label-text">ä½ç½®é”šç‚¹</span></div>
                    <select id="sticker1Pos" class="save-state" onchange="update()">
                        <option value="br">å³ä¸‹è§’ (Bottom-Right)</option>
                        <option value="bl">å·¦ä¸‹è§’ (Bottom-Left)</option>
                        <option value="tr">å³ä¸Šè§’ (Top-Right)</option>
                        <option value="tl">å·¦ä¸Šè§’ (Top-Left)</option>
                        <option value="center">æ­£ä¸­å¿ƒ (Center)</option>
                        <option value="tc">ä¸Šä¸­ (Top-Center)</option>
                        <option value="bc">ä¸‹ä¸­ (Bottom-Center)</option>
                        <option value="lc">å·¦ä¸­ (Left-Center)</option>
                        <option value="rc">å³ä¸­ (Right-Center)</option>
                    </select>

                    <div class="label-row" style="margin-top:10px;">
                        <span class="label-text">ä¸é€æ˜åº¦</span>
                        <span class="label-val" id="val-s1Op">1.0</span>
                    </div>
                    <input type="range" id="sticker1Op" class="save-state" min="0" max="1" step="0.05" value="1" oninput="update()">

                    <div class="label-row" style="margin-top:10px;">
                        <span class="label-text">å¤§å°</span>
                        <span class="label-val" id="val-s1Size">40</span>
                    </div>
                    <input type="range" id="sticker1Size" class="save-state" min="10" max="200" value="40" oninput="update()">

                    <div style="display:flex; flex-direction:column; gap:10px; margin-top:15px;">
                        <div>
                            <div class="label-row">
                                <span class="label-text">X åç§» (æ”¯æŒè¾“å…¥)</span>
                                <input type="number" id="num-s1X" class="num-input" value="-10" oninput="syncNum('num-s1X', 'sticker1X')">
                            </div>
                            <input type="range" id="sticker1X" class="save-state" min="-100" max="100" step="0.5" value="-10" oninput="syncRange('sticker1X', 'num-s1X')">
                        </div>
                        <div>
                            <div class="label-row">
                                <span class="label-text">Y åç§» (æ”¯æŒè¾“å…¥)</span>
                                <input type="number" id="num-s1Y" class="num-input" value="-10" oninput="syncNum('num-s1Y', 'sticker1Y')">
                            </div>
                            <input type="range" id="sticker1Y" class="save-state" min="-100" max="100" step="0.5" value="-10" oninput="syncRange('sticker1Y', 'num-s1Y')">
                        </div>
                    </div>
                </div>
            </div>

            <!-- è´´å›¾2 (Before) -->
            <div class="control-group" style="padding-top:20px;">
                <div class="label-row">
                    <span class="label-text">è´´å›¾ 2 (::before) - è¾…åŠ©è´´å›¾</span>
                    <label style="font-size:11px; color:#555;">
                        <input type="checkbox" id="sticker2Switch" class="save-state" onchange="update()"> å¯ç”¨
                    </label>
                </div>
                <div id="sticker2DisabledMsg" style="display:none; color:#ff4d4f; font-size:11px; margin-top:5px;">âš ï¸ å·²å¯ç”¨æµå…‰è¾¹æ¡†ï¼Œè´´å›¾2æš‚æ—¶ä¸å¯ç”¨ (::before è¢«å ç”¨)ã€‚</div>
                <div id="sticker2Controls" style="display:none; background:#fff4f4; padding:10px; border-radius:8px; margin-top:10px; border:1px solid #ffdcdc;">
                    <div style="font-size:11px; color:#d93025; margin-bottom:10px;">âš ï¸ è­¦å‘Šï¼šå¯ç”¨æ­¤è´´å›¾å¯èƒ½ä¼šå¯¼è‡´éƒ¨åˆ†è½¯ä»¶çš„æ°”æ³¡å°å°¾å·´æ¶ˆå¤±ã€‚</div>
                    
                    <div class="label-text" style="margin-bottom:6px;">ä¸Šä¼ æˆ–è¾“å…¥URL</div>
                    <input type="file" onchange="uploadImg(this, 'sticker2')" style="font-size:12px; width:100%; margin-bottom:5px;">
                    <div style="display:flex; gap:6px;">
                        <input type="text" id="sticker2UrlInput" placeholder="http://..." style="flex:1; padding:6px; border:1px solid #ddd; border-radius:4px; font-size:12px;">
                        <button onclick="applyStickerUrl(2)" style="border:1px solid #ddd; background:#fff; border-radius:4px; cursor:pointer; font-size:12px; padding:0 10px;">åº”ç”¨</button>
                    </div>

                    <div class="label-row" style="margin-top:10px;"><span class="label-text">ä½ç½®é”šç‚¹</span></div>
                    <select id="sticker2Pos" class="save-state" onchange="update()">
                        <option value="tl">å·¦ä¸Šè§’ (Top-Left)</option>
                        <option value="tr">å³ä¸Šè§’ (Top-Right)</option>
                        <option value="bl">å·¦ä¸‹è§’ (Bottom-Left)</option>
                        <option value="br">å³ä¸‹è§’ (Bottom-Right)</option>
                        <option value="center">æ­£ä¸­å¿ƒ (Center)</option>
                        <option value="tc">ä¸Šä¸­ (Top-Center)</option>
                        <option value="bc">ä¸‹ä¸­ (Bottom-Center)</option>
                        <option value="lc">å·¦ä¸­ (Left-Center)</option>
                        <option value="rc">å³ä¸­ (Right-Center)</option>
                    </select>

                    <div class="label-row" style="margin-top:10px;">
                        <span class="label-text">ä¸é€æ˜åº¦</span>
                        <span class="label-val" id="val-s2Op">1.0</span>
                    </div>
                    <input type="range" id="sticker2Op" class="save-state" min="0" max="1" step="0.05" value="1" oninput="update()">

                    <div class="label-row" style="margin-top:10px;">
                        <span class="label-text">å¤§å°</span>
                        <span class="label-val" id="val-s2Size">40</span>
                    </div>
                    <input type="range" id="sticker2Size" class="save-state" min="10" max="200" value="40" oninput="update()">

                    <div style="display:flex; flex-direction:column; gap:10px; margin-top:15px;">
                        <div>
                            <div class="label-row">
                                <span class="label-text">X åç§» (æ”¯æŒè¾“å…¥)</span>
                                <input type="number" id="num-s2X" class="num-input" value="10" oninput="syncNum('num-s2X', 'sticker2X')">
                            </div>
                            <input type="range" id="sticker2X" class="save-state" min="-100" max="100" step="0.5" value="10" oninput="syncRange('sticker2X', 'num-s2X')">
                        </div>
                        <div>
                            <div class="label-row">
                                <span class="label-text">Y åç§» (æ”¯æŒè¾“å…¥)</span>
                                <input type="number" id="num-s2Y" class="num-input" value="10" oninput="syncNum('num-s2Y', 'sticker2Y')">
                            </div>
                            <input type="range" id="sticker2Y" class="save-state" min="-100" max="100" step="0.5" value="10" oninput="syncRange('sticker2Y', 'num-s2Y')">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Tab 6: è£…é¥° (New) -->
        <div class="tab-content" id="tab6">
            <div class="control-group">
                <h2>å¤šå±‚è£…é¥°ç³»ç»Ÿ</h2>
                <div style="font-size:11px; color:#666; margin-bottom:15px;">
                    æ·»åŠ åœ†å½¢æˆ–å›¾ç‰‡ä½œä¸ºèƒŒæ™¯å±‚ã€‚
                    <br><strong>% ç›¸å¯¹å®šä½ï¼š</strong>éšæ°”æ³¡æ‹‰ä¼¸ (é€‚åˆå±…ä¸­)
                    <br><strong>px ç»å¯¹å®šä½ï¼š</strong>å›ºå®šåœ¨è§’è½ (é€‚åˆè§’æ ‡ï¼Œä¸ä¼šæ¶ˆå¤±)
                </div>
                
                <button class="add-layer-btn" onclick="addDecorationLayer()">+ æ·»åŠ è£…é¥°å›¾å±‚</button>
                <div class="layer-list" id="layerList"></div>
            </div>
        </div>

        <!-- Tab 4: æ¨¡æ‹Ÿ -->
        <div class="tab-content" id="tab4">
            <div class="role-switcher">
                <button class="role-btn active" onclick="setSimMode('standard', this)">æ ‡å‡†å¯¹è¯ (ç°/å½©)</button>
                <button class="role-btn" onclick="setSimMode('symmetric', this)">åŒå‘åº”ç”¨ (å½©/å½©)</button>
                <button class="role-btn" onclick="setSimMode('me', this)">åªçœ‹æˆ‘</button>
                <button class="role-btn" onclick="setSimMode('opponent', this)">åªçœ‹ä»–</button>
            </div>
            
            <div style="padding:10px; text-align:center; color:#888; font-size:13px; line-height:1.6; border:1px dashed #ddd; border-radius:8px;">
                <p style="color:#333; font-weight:600; margin-bottom:5px;"> æ¨¡æ‹Ÿæ¨¡å¼å·²æ¿€æ´»</p>
                <p>æ‰‹æœºä¼šè‡ªåŠ¨è¿›å…¥å·¨å¹•æ¨¡å¼ã€‚</p>
                <p>é€‰æ‹©ã€åŒå‘åº”ç”¨ã€‘å¯è®©åŒæ–¹éƒ½æ˜¾ç¤º<br>æ‚¨å½“å‰è®¾è®¡çš„æ°”æ³¡æ ·å¼ã€‚</p>
            </div>
        </div>

        <!-- Tab 5: å¯¼å‡º -->
        <div class="tab-content" id="tab5">
            <div class="control-group">
                <div class="label-row"><span class="label-text">é€‰æ‹©é€‰æ‹©å™¨</span></div>
                <select id="selectorType" onchange="update()">
                    <option value="all">æ‰€æœ‰æ°”æ³¡ (.message-bubble)</option>
                    <option value="sent">ç”¨æˆ·å‘é€ (.message-container.sent ...)</option>
                    <option value="received">å¯¹æ–¹æ¥æ”¶ (.message-container.received ...)</option>
                </select>
            </div>

            <!-- æ–°å¢ï¼šå›¾ç‰‡é“¾æ¥ä¿®å¤é¢æ¿ -->
            <div class="control-group" id="urlFixPanel" style="background:#fff8e6; border:1px solid #ffeeba; padding:12px; border-radius:8px; margin-bottom:15px; display:none;">
                <div class="label-row" style="border-bottom:1px solid #e6dbb9; padding-bottom:5px; margin-bottom:10px;">
                    <span class="label-text" style="color:#856404;">ğŸ”— å›¾ç‰‡é“¾æ¥ä¿®å¤ (Image Fix)</span>
                </div>
                <div style="font-size:11px; color:#856404; margin-bottom:10px;">
                    åœ¨æ­¤å¤„ä¿®æ”¹é“¾æ¥ä¼šè‡ªåŠ¨åŒæ­¥åˆ°æ‰€æœ‰è®¾ç½®ã€‚ä¿®æ”¹åå¯æ”¾å¿ƒè¿”å›è°ƒæ•´ä½ç½®ï¼Œé“¾æ¥ä¸ä¼šå¤±æ•ˆã€‚
                </div>
                <div id="urlFixList" style="display:flex; flex-direction:column; gap:8px;"></div>
            </div>

            <button class="copy-btn-main" onclick="copyCSS()">ä¸€é”®å¤åˆ¶ CSS ä»£ç </button>
            <div class="code-box" id="codeOut"></div>
        </div>
    </div>

    <!-- å³ä¾§é¢„è§ˆåŒº -->
    <div class="preview-area" id="previewCanvas">
        <div class="canvas-toolbar">
            <button class="toolbar-btn active" onclick="setCanvas('grid')">ç½‘æ ¼</button>
            <button class="toolbar-btn" onclick="setCanvas('light')">æµ…è‰²</button>
            <button class="toolbar-btn" onclick="setCanvas('dark')">æ·±è‰²</button>
            <button class="toolbar-btn" onclick="document.getElementById('canvasUpload').click()">è‡ªå®šä¹‰</button>
            <input type="file" id="canvasUpload" style="display:none" onchange="uploadCanvasBg(this)">
        </div>

        <div class="preview-stage" id="stage">
            <div class="preview-bubble" id="soloBubble">
                Hi! è¿™é‡Œæ˜¯é¢„è§ˆã€‚
            </div>

            <div class="chat-container" id="chatSim" style="display:none;">
                <div class="chat-row left sim-row-left">
                    <div class="chat-avatar"></div>
                    <div class="chat-bubble-gray sim-bubble-left">Hi</div>
                </div>
                <div class="chat-row right sim-row-right">
                    <div class="chat-avatar"></div>
                    <div class="preview-bubble sim-bubble-right">è¿™æ•ˆæœæ€ä¹ˆæ ·ï¼Ÿ</div>
                </div>
                <div class="chat-row right sim-row-right"> 
                    <div class="chat-avatar" style="visibility:hidden"></div>
                    <div class="preview-bubble sim-bubble-right">Min-Width ä¿®å¤äº†å †å é—®é¢˜ã€‚å½“æ°”æ³¡å˜å¤§æ—¶ï¼Œç»å¯¹å®šä½çš„è£…é¥°ä¸ä¼šæ¶ˆå¤±ã€‚</div>
                </div>
                <div class="chat-row left sim-row-left">
                    <div class="chat-avatar"></div>
                    <div class="chat-bubble-gray sim-bubble-left">ä¸é”™ã€‚</div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="creator-watermark">
    <span>UI Modify by <strong>2367304947</strong></span>
    <span class="divider">|</span>
    <span>Original Core by <strong>é²·é±¼çƒ§</strong></span>
    <div class="license-note">ç¦æ­¢äºŒä¼  / ç¦æ­¢å€’å–</div>
</div>

<script>
let assets = { bg: "none", sticker1: null, sticker2: null };
let canvasBg = "";
let gradState = { x: 80, y: 80, angle: 135 };
let simMode = 'standard'; 
let decorations = []; // List of decoration layers

function switchTab(idx) {
    document.querySelectorAll('.tab-btn').forEach((b, i) => {
        b.classList.remove('active');
        if (b.innerText === ['å¤–è§‚','è´¨æ„Ÿ','è’™ç‰ˆ','è´´å›¾','æ¨¡æ‹Ÿ','å¯¼å‡º','è£…é¥°'][idx]) b.classList.add('active');
    });
    
    const tabs = ['tab0','tab1','tab2','tab3','tab4','tab5','tab6'];
    tabs.forEach(id => document.getElementById(id).classList.remove('active'));
    document.getElementById(tabs[idx]).classList.add('active');
    
    // Button active state fix (simple way)
    const buttons = document.querySelectorAll('.tab-btn');
    buttons.forEach(b => b.classList.remove('active'));
    const activeBtn = Array.from(buttons).find(b => b.getAttribute('onclick') === `switchTab(${idx})`);
    if(activeBtn) activeBtn.classList.add('active');

    const solo = document.getElementById('soloBubble');
    const sim = document.getElementById('chatSim');
    const body = document.body;
    
    if (idx === 4) { // Tab 4 is Simulation
        solo.style.display = 'none';
        sim.style.display = 'flex';
        body.classList.add('sim-mode'); 
        update(); 
    } else {
        solo.style.display = 'inline-block';
        sim.style.display = 'none';
        body.classList.remove('sim-mode');
    }
    
    // Auto Render Fix Panel if export tab
    if (idx === 5) renderUrlFixPanel();
}

function setSimMode(mode, btn) {
    simMode = mode;
    document.querySelectorAll('.role-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    
    const leftRows = document.querySelectorAll('.sim-row-left');
    const rightRows = document.querySelectorAll('.sim-row-right');
    
    if(mode === 'standard' || mode === 'symmetric') {
        leftRows.forEach(r => r.style.display = 'flex');
        rightRows.forEach(r => r.style.display = 'flex');
    } else if (mode === 'me') {
        leftRows.forEach(r => r.style.display = 'none');
        rightRows.forEach(r => r.style.display = 'flex');
    } else if (mode === 'opponent') {
        leftRows.forEach(r => r.style.display = 'flex');
        rightRows.forEach(r => r.style.display = 'none');
    }
    update();
}

function syncNum(numId, rangeId) {
    const val = document.getElementById(numId).value;
    document.getElementById(rangeId).value = val;
    update();
}
function syncRange(rangeId, numId) {
    const val = document.getElementById(rangeId).value;
    document.getElementById(numId).value = val;
    update();
}

function syncColor(pickerId, textId) {
    document.getElementById(textId).value = document.getElementById(pickerId).value;
}
function syncHex(textId, pickerId) {
    let val = document.getElementById(textId).value;
    if(val.length === 7 && val.startsWith('#')) {
        document.getElementById(pickerId).value = val;
    }
}

// Decoration Logic
function addDecorationLayer() {
    decorations.push({
        type: 'circle',
        color: '#ffcc00',
        size: 50,
        x: 50,
        y: 50,
        opacity: 1,
        url: '',
        posMode: 'percent', // 'percent' or 'absolute'
        anchor: 'tl' // tl, tr, bl, br, center
    });
    renderDecorationList();
    update();
}

function removeDecoration(index) {
    decorations.splice(index, 1);
    renderDecorationList();
    update();
}

function updateDecoration(index, key, val) {
    decorations[index][key] = val;
    if (key === 'type' || key === 'posMode') renderDecorationList();
    update();
}

function uploadDecorationImg(input, index) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = (e) => { 
            decorations[index].url = `url('${e.target.result}')`; 
            renderDecorationList();
            update(); 
        };
        reader.readAsDataURL(input.files[0]);
    }
}

function renderDecorationList() {
    const list = document.getElementById('layerList');
    list.innerHTML = '';
    decorations.forEach((layer, i) => {
        const item = document.createElement('div');
        item.className = 'layer-item';
        
        let controls = `
            <div class="label-row">
                <select onchange="updateDecoration(${i}, 'type', this.value)" style="width:40%">
                    <option value="circle" ${layer.type==='circle'?'selected':''}>åœ†å½¢ (Circle)</option>
                    <option value="image" ${layer.type==='image'?'selected':''}>å›¾ç‰‡ (Image)</option>
                </select>
                <input type="range" class="mini-alpha" min="0" max="1" step="0.1" value="${layer.opacity}" oninput="updateDecoration(${i}, 'opacity', this.value)" title="é€æ˜åº¦" style="width:50%">
            </div>
        `;
        
        if (layer.type === 'image') {
            controls += `
                <div class="label-row" style="margin-top:5px; gap:5px;">
                     <input type="file" onchange="uploadDecorationImg(this, ${i})" style="font-size:11px; width:60%">
                     <input type="text" placeholder="URL" value="${layer.url}" onchange="updateDecoration(${i}, 'url', this.value)" style="flex:1; font-size:11px; padding:4px; border:1px solid #ddd;">
                </div>
            `;
        } else {
            controls += `
                <div class="label-row">
                    <input type="color" value="${layer.color}" oninput="updateDecoration(${i}, 'color', this.value)" style="width:30px; height:20px;">
                </div>
            `;
        }
        
        // Position Mode Selector
        let posControls = '';
        if (layer.posMode === 'absolute') {
            posControls = `
                <select onchange="updateDecoration(${i}, 'anchor', this.value)" style="flex:1;">
                    <option value="tl" ${layer.anchor==='tl'?'selected':''}>å·¦ä¸Š (Top-Left)</option>
                    <option value="tr" ${layer.anchor==='tr'?'selected':''}>å³ä¸Š (Top-Right)</option>
                    <option value="bl" ${layer.anchor==='bl'?'selected':''}>å·¦ä¸‹ (Bottom-Left)</option>
                    <option value="br" ${layer.anchor==='br'?'selected':''}>å³ä¸‹ (Bottom-Right)</option>
                    <option value="center" ${layer.anchor==='center'?'selected':''}>ä¸­å¿ƒ (Center)</option>
                </select>
            `;
        }

        const isAbs = layer.posMode === 'absolute';
        const rangeMin = isAbs ? -100 : -50;
        const rangeMax = isAbs ? 200 : 150;
        const unit = isAbs ? 'px' : '%';
        const labelX = isAbs ? 'X åç§»' : 'X ä½ç½®';
        const labelY = isAbs ? 'Y åç§»' : 'Y ä½ç½®';

        controls += `
             <div style="margin-top:8px;">
                <div class="label-row" style="justify-content:flex-start; gap:10px;">
                    <span style="font-size:10px;">å®šä½æ¨¡å¼:</span>
                    <label style="font-size:10px;"><input type="radio" name="dm${i}" onchange="updateDecoration(${i}, 'posMode', 'percent')" ${!isAbs?'checked':''}> % ç›¸å¯¹</label>
                    <label style="font-size:10px;"><input type="radio" name="dm${i}" onchange="updateDecoration(${i}, 'posMode', 'absolute')" ${isAbs?'checked':''}> px ç»å¯¹</label>
                </div>
                ${isAbs ? `<div class="label-row" style="margin-top:4px;">${posControls}</div>` : ''}

                <div style="display:flex; gap:5px; align-items:center; margin-top:8px;">
                    <span style="font-size:10px; width:25px;">å¤§å°</span>
                    <input type="range" min="5" max="300" value="${layer.size}" oninput="updateDecoration(${i}, 'size', this.value)" style="flex:1">
                    <span style="font-size:10px; color:#999; width:20px;">px</span>
                </div>
                <div style="display:flex; gap:5px; align-items:center; margin-top:5px;">
                    <span style="font-size:10px; width:25px;">${isAbs?'X':'X'}</span>
                    <input type="range" min="${rangeMin}" max="${rangeMax}" value="${layer.x}" oninput="updateDecoration(${i}, 'x', this.value); this.nextElementSibling.value=this.value" style="flex:1">
                    <input type="number" class="num-input" value="${layer.x}" oninput="updateDecoration(${i}, 'x', this.value); this.previousElementSibling.value=this.value">
                    <span style="font-size:10px; width:15px; text-align:right;">${unit}</span>
                </div>
                <div style="display:flex; gap:5px; align-items:center; margin-top:4px;">
                    <span style="font-size:10px; width:25px;">${isAbs?'Y':'Y'}</span>
                    <input type="range" min="${rangeMin}" max="${rangeMax}" value="${layer.y}" oninput="updateDecoration(${i}, 'y', this.value); this.nextElementSibling.value=this.value" style="flex:1">
                    <input type="number" class="num-input" value="${layer.y}" oninput="updateDecoration(${i}, 'y', this.value); this.previousElementSibling.value=this.value">
                    <span style="font-size:10px; width:15px; text-align:right;">${unit}</span>
                </div>
            </div>
        `;

        item.innerHTML = `
            <div class="layer-header">
                <span class="layer-title">å›¾å±‚ ${i+1}</span>
                <span class="layer-remove" onclick="removeDecoration(${i})">åˆ é™¤</span>
            </div>
            ${controls}
        `;
        list.appendChild(item);
    });
}


const configs = {
    classic: { count:1, type:'none', alpha: 1, radius: 18, bwidth: 1.5, bstyle:'dashed', boffset:-6, shadow: 8, inset: 0, blur: 0, pady: 10, padx: 12, colors: ['#ffffff'], gb: false },
    glass: { count:1, type:'linear', alpha: 0.35, radius: 18, bwidth: 1, bstyle:'solid', boffset:0, shadow: 20, inset: 0, blur: 18, pady: 12, padx: 16, colors: ['#ffffff'], gb: false },
    raindrop: { count:2, type:'radial', alpha: 0.25, radius: 35, bwidth: 0, bstyle:'solid', boffset:0, shadow: 25, inset: 22, blur: 6, pady: 14, padx: 18, colors: ['#ffffff', '#e0f7fa'], gb: false },
    pearl: { count:3, type:'radial', alpha: 1, radius: 50, bwidth: 0, bstyle:'solid', boffset:0, shadow: 18, inset: 32, blur: 0, pady: 12, padx: 16, colors: ['#ffffff', '#f8f8f8', '#d0d0d0'], gb: false },
    gradient: { count:2, type:'linear', alpha: 1, radius: 16, bwidth: 0, bstyle:'solid', boffset:0, shadow: 12, inset: 0, blur: 0, pady: 12, padx: 16, colors: ['#a18cd1', '#fbc2eb'], gb: false },
    dark: { count:1, type:'linear', alpha: 0.95, radius: 14, bwidth: 0, bstyle:'solid', boffset:0, shadow: 25, inset: 6, blur: 0, pady: 12, padx: 16, colors: ['#1c1c1e'], gb: false },
    custom: null
};

function applyPreset(name) {
    currentMode = name;
    const c = configs[name];
    if (c) {
        document.getElementById('lockCorners').checked = true;
        updateLock();
        document.getElementById('colorCount').value = c.count;
        document.getElementById('gradType').value = c.type;
        document.getElementById('alpha').value = c.alpha;
        document.querySelectorAll('.alpha-in').forEach(el => el.value = c.alpha);
        document.getElementById('fontAlpha').value = 1;
        document.getElementById('borderAlpha').value = 1;
        document.getElementById('radius').value = c.radius;
        document.getElementById('bwidth').value = c.bwidth;
        document.getElementById('borderStyle').value = c.bstyle;
        document.getElementById('boffset').value = c.boffset;
        document.getElementById('shadow').value = c.shadow;
        document.getElementById('inset').value = c.inset;
        document.getElementById('blur').value = c.blur;
        
        // Reset Secondary Border
        document.getElementById('b2Switch').checked = false;
        
        // Padding Reset
        document.getElementById('padLock').checked = true;
        togglePadLock();
        document.getElementById('pady').value = c.pady;
        document.getElementById('padx').value = c.padx;
        updatePad('x'); updatePad('y'); // Sync to individual

        document.getElementById('gradBorderSwitch').checked = c.gb || false;
        document.getElementById('sheenSwitch').checked = false;

        const inputs = document.querySelectorAll('.color-in');
        c.colors.forEach((hex, i) => { 
            if(inputs[i]) {
                inputs[i].value = hex;
                document.getElementById('h'+(i+1)).value = hex;
            } 
        });
    }
    update();
}

function setCanvas(mode) {
    const canvas = document.getElementById('previewCanvas');
    document.querySelectorAll('.toolbar-btn').forEach(b => b.classList.remove('active'));
    const btnMap = { 'grid': 0, 'light': 1, 'dark': 2, 'upload': 3 };
    if(btnMap[mode] !== undefined) {
        document.querySelectorAll('.toolbar-btn')[btnMap[mode]].classList.add('active');
    }
    
    if (mode === 'grid') { canvas.style.background = "#e5e5f7 radial-gradient(#444cf7 0.5px, #e5e5f7 0.5px)"; canvas.style.backgroundSize = "24px 24px"; }
    else if (mode === 'light') { canvas.style.background = "#f2f2f6"; }
    else if (mode === 'dark') { canvas.style.background = "#000000"; }
    else if (mode === 'upload' && canvasBg) { canvas.style.background = canvasBg; canvas.style.backgroundSize = "cover"; canvas.style.backgroundPosition = "center"; }
    
    localStorage.setItem('eve_canvas_mode_final', mode);
}

function uploadCanvasBg(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = (e) => { canvasBg = `url('${e.target.result}')`; setCanvas('upload'); };
        reader.readAsDataURL(input.files[0]);
    }
}

function updateLock() {
    const locked = document.getElementById('lockCorners').checked;
    document.getElementById('unifiedRadiusControl').style.display = locked ? 'block' : 'none';
    document.getElementById('cornerControls').style.display = locked ? 'none' : 'grid';
    update();
}

function togglePadLock() {
    const locked = document.getElementById('padLock').checked;
    document.getElementById('pad-symmetric').style.display = locked ? 'block' : 'none';
    document.getElementById('pad-independent').style.display = locked ? 'none' : 'grid';
    if(locked) {
        updatePad('x');
        updatePad('y');
    }
}

function updatePad(axis) {
    if(axis === 'x') {
        const val = document.getElementById('padx').value;
        document.getElementById('pl').value = val;
        document.getElementById('pr').value = val;
    } else {
        const val = document.getElementById('pady').value;
        document.getElementById('pt').value = val;
        document.getElementById('pb').value = val;
    }
    update();
}

function uploadImg(input, key) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = (e) => { assets[key] = `url('${e.target.result}')`; update(); };
        reader.readAsDataURL(input.files[0]);
    }
}

function applyBgUrl() {
    const url = document.getElementById('bgUrlInput').value;
    if (url) { assets.bg = `url('${url}')`; update(); }
}

function applyStickerUrl(index) {
    const inputId = index === 1 ? 'sticker1UrlInput' : 'sticker2UrlInput';
    const key = index === 1 ? 'sticker1' : 'sticker2';
    const url = document.getElementById(inputId).value;
    if (url) { 
        const finalUrl = url.trim().startsWith('url') ? url : `url('${url}')`;
        assets[key] = finalUrl; 
        update(); 
    }
}

function toggleAutoColor(isAuto) {
    if(!isAuto) document.getElementById('autoColorSwitch').checked = false;
}

function syncGlobalAlpha() {
    const globalVal = document.getElementById('alpha').value;
    document.querySelectorAll('.alpha-in').forEach(el => el.value = globalVal);
}

function hexToRgba(hex, a) {
    const r = parseInt(hex.slice(1,3), 16), g = parseInt(hex.slice(3,5), 16), b = parseInt(hex.slice(5,7), 16);
    return `rgba(${r}, ${g}, ${b}, ${a})`;
}

function saveState() {
    const state = {};
    document.querySelectorAll('.save-state').forEach(el => {
        state[el.id] = (el.type === 'checkbox') ? el.checked : el.value;
    });
    state['gradPos'] = gradState;
    state['decorations'] = decorations; 
    ['h1','h2','h3','h4'].forEach(id => state[id] = document.getElementById(id).value);
    ['num-s1X','num-s1Y','num-s2X','num-s2Y'].forEach(id => state[id] = document.getElementById(id).value);
    ['b2Hex'].forEach(id => { if(document.getElementById(id)) state[id] = document.getElementById(id).value; });
    
    localStorage.setItem('eveBubbleState_Final_V12', JSON.stringify(state));
}

function loadState() {
    const saved = localStorage.getItem('eveBubbleState_Final_V12');
    if (saved) {
        const state = JSON.parse(saved);
        for (const key in state) {
            const el = document.getElementById(key);
            if (el && key !== 'decorations') {
                if (el.type === 'checkbox') el.checked = state[key];
                else el.value = state[key];
            }
        }
        if (state['gradPos']) {
            gradState = state['gradPos'];
            const point = document.getElementById('gradPoint');
            const line = document.getElementById('gradLine');
            point.style.left = gradState.x + '%';
            point.style.top = gradState.y + '%';
            line.style.transform = `rotate(${gradState.angle}deg)`;
        }
        if (state['decorations']) {
            decorations = state['decorations'];
            // Migration fix for older saves without posMode
            decorations.forEach(d => { if(!d.posMode) d.posMode = 'percent'; });
            renderDecorationList();
        }
        updateLock();
        togglePadLock(); 
        
        // Force sync for old saves
        if(document.getElementById('padLock').checked) {
             updatePad('x'); updatePad('y');
        }

        return true;
    }
    return false;
}

function resetMemory() {
    if(confirm('ç¡®å®šè¦æ¸…é™¤è®°å¿†å¹¶æ¢å¤é»˜è®¤è®¾ç½®å—ï¼Ÿ')) {
        localStorage.removeItem('eveBubbleState_Final_V12');
        location.reload();
    }
}

function copyCSS() {
    const text = codeOut.innerText;
    navigator.clipboard.writeText(text).then(() => {
        const btn = document.querySelector('.copy-btn-main');
        const oldText = btn.innerText;
        btn.innerText = ' å·²å¤åˆ¶åˆ°å‰ªè´´æ¿';
        btn.style.background = '#34c759';
        setTimeout(() => { btn.innerText = oldText; btn.style.background = '#0066CC'; }, 2000);
    });
}

const pad = document.getElementById('gradPad');
const point = document.getElementById('gradPoint');
const line = document.getElementById('gradLine');
let isDragging = false;
pad.addEventListener('mousedown', (e) => { isDragging = true; updateGradPos(e); });
window.addEventListener('mousemove', (e) => { if(isDragging) updateGradPos(e); });
window.addEventListener('mouseup', () => { isDragging = false; });
function updateGradPos(e) {
    const rect = pad.getBoundingClientRect();
    let x = e.clientX - rect.left;
    let y = e.clientY - rect.top;
    x = Math.max(0, Math.min(x, rect.width));
    y = Math.max(0, Math.min(y, rect.height));
    const pctX = (x / rect.width) * 100;
    const pctY = (y / rect.height) * 100;
    point.style.left = pctX + '%';
    point.style.top = pctY + '%';
    const centerX = rect.width / 2;
    const centerY = rect.height / 2;
    const deg = Math.atan2(y - centerY, x - centerX) * (180 / Math.PI) + 90;
    line.style.transform = `rotate(${deg}deg)`;
    gradState = { x: Math.round(pctX), y: Math.round(pctY), angle: Math.round(deg) };
    update();
}

function update() {
    const v = (id) => { const el = document.getElementById(id); return el ? el.value : 0; };
    
    // 1. è·å–å¼€å…³çŠ¶æ€
    const hasSticker1 = document.getElementById('sticker1Switch').checked;
    let hasSticker2 = document.getElementById('sticker2Switch').checked;
    const isGb = document.getElementById('gradBorderSwitch').checked; // æµå…‰è¾¹æ¡†
    const isB2 = document.getElementById('b2Switch').checked; // ç¬¬äºŒè¾¹æ¡†
    
    // å¤„ç†æµå…‰è¾¹æ¡†ä¸Sticker2çš„å†²çª
    if (isGb) {
        document.getElementById('sticker2Controls').style.display = 'none';
        document.getElementById('sticker2DisabledMsg').style.display = 'block';
        hasSticker2 = false; 
    } else {
        document.getElementById('sticker2DisabledMsg').style.display = 'none';
        document.getElementById('sticker2Controls').style.display = hasSticker2 ? 'block' : 'none';
    }

    document.getElementById('sticker1Controls').style.display = hasSticker1 ? 'block' : 'none';
    document.getElementById('b2Controls').style.display = isB2 ? 'block' : 'none';

    // æ›´æ–°æ•°å€¼æ˜¾ç¤º
    ['radius','inset','blur','alpha','bwidth','shadow','boffset','pady','padx','b2width','maxWidth'].forEach(id => {
        if(document.getElementById('val-'+id)) document.getElementById('val-'+id).innerText = v(id);
    });
    // New Pad Values
    ['pt','pb','pl','pr'].forEach(id => {
        if(document.getElementById('val-'+id)) document.getElementById('val-'+id).innerText = v(id);
    });

    if(document.getElementById('val-sheenW')) document.getElementById('val-sheenW').innerText = v('sheenWidth');
    
    ['sticker1Size','sticker1Op'].forEach(id => {
        if(document.getElementById('val-'+id.replace('sticker1','s1'))) 
             document.getElementById('val-'+id.replace('sticker1','s1')).innerText = v(id);
    });
    ['sticker2Size','sticker2Op'].forEach(id => {
        if(document.getElementById('val-'+id.replace('sticker2','s2'))) 
             document.getElementById('val-'+id.replace('sticker2','s2')).innerText = v(id);
    });

    saveState();

    const count = parseInt(v('colorCount'));
    const colorIns = document.querySelectorAll('.color-wrapper'); 
    colorIns.forEach((grp, i) => grp.style.opacity = (i < count) ? "1" : "0.2");
    
    const colors = [];
    for(let i=1; i<=count; i++) {
        const hex = document.getElementById('h'+i).value;
        const alpha = document.getElementById('a'+i).value;
        colors.push(hexToRgba(hex, alpha));
    }
    
    let gradBase = colors.length > 1 ? colors.join(', ') : `${colors[0]}, ${colors[0]}`;
    
    const gType = v('gradType');
    let finalGrad = '';
    document.getElementById('gradLine').style.display = (gType === 'linear') ? 'block' : 'none';

    if (gType === 'none') {
        finalGrad = colors[0];
        if(colors.length === 1) finalGrad = `linear-gradient(0deg, ${colors[0]}, ${colors[0]})`; 
    } else if (gType === 'linear') {
        finalGrad = `linear-gradient(${gradState.angle}deg, ${gradBase})`;
    } else {
        finalGrad = `radial-gradient(circle at ${gradState.x}% ${gradState.y}%, ${gradBase})`;
    }

    const isLocked = document.getElementById('lockCorners').checked;
    let radiusVal = isLocked ? `${v('radius')}px` : `${v('r_tl')}px ${v('r_tr')}px ${v('r_br')}px ${v('r_bl')}px`;

    const ins = v('inset');
    const sColorHex = document.getElementById('shadowColor').value;
    const sColorA = document.getElementById('shadowAlpha').value;
    const sColor = hexToRgba(sColorHex, sColorA);
    const outShadow = `0 ${v('shadow')/2}px ${v('shadow')}px ${sColor}`;
    const inLight = `inset ${ins/2}px ${ins/2}px ${ins}px rgba(255,255,255,0.85)`;
    const inDark = `inset -${ins/3}px -${ins/3}px ${ins}px rgba(0,0,0,0.12)`;
    let bubbleBoxShadow = `${outShadow}, ${inLight}, ${inDark}`;
    
    const rawHex = document.getElementById('h1').value;
    const r = parseInt(rawHex.slice(1,3), 16), g = parseInt(rawHex.slice(3,5), 16), b = parseInt(rawHex.slice(5,7), 16);
    const brightness = (r * 299 + g * 587 + b * 114) / 1000;
    let textColor = (v('alpha') > 0.4 && brightness < 155) ? '#ffffff' : '#444444'; 
    if (!document.getElementById('autoColorSwitch').checked) {
        textColor = hexToRgba(document.getElementById('fontHex').value, v('fontAlpha'));
    }

    const hasSheen = document.getElementById('sheenSwitch').checked;
    document.getElementById('sheenControls').style.display = hasSheen ? 'block' : 'none';
    let sheenLayer = "";
    if (hasSheen) {
        const sOp = v('sheenOp');
        const sPos = parseInt(v('sheenPos'));
        const sAng = v('sheenAngle');
        const sWidth = parseInt(v('sheenWidth'));
        const sColorHex = document.getElementById('sheenHex').value;
        const start = Math.max(0, sPos - sWidth);
        const end = Math.min(100, sPos + sWidth);
        const sColorRgba = hexToRgba(sColorHex, sOp);
        sheenLayer = `linear-gradient(${sAng}deg, transparent ${start}%, ${sColorRgba} ${sPos}%, transparent ${end}%)`;
    }

    // --- åº”ç”¨ç›®æ ‡é€»è¾‘ ---
    let targets = [];
    targets.push(document.getElementById('soloBubble'));
    document.querySelectorAll('.sim-bubble-right').forEach(el => targets.push(el));
    document.querySelectorAll('.sim-bubble-left').forEach(el => {
        if (simMode === 'symmetric' || simMode === 'opponent') {
            el.className = 'preview-bubble sim-bubble-left'; 
            targets.push(el);
        } else {
            el.className = 'chat-bubble-gray sim-bubble-left';
            el.style = ""; 
        }
    });

    let bgImages = [], bgPositions = [], bgSizes = [], bgRepeats = [];
    let clips = [];

    if(hasSheen) { 
        bgImages.push(sheenLayer); 
        bgPositions.push('center');
        bgSizes.push('cover');
        bgRepeats.push('no-repeat');
        clips.push("padding-box"); 
    }
    
    // Decorations Layer - UPDATED LOGIC (Anchor support)
    decorations.forEach(dec => {
        const op = dec.opacity;
        // Determine Position String
        let posStr = 'center';
        if (!dec.posMode || dec.posMode === 'percent') {
            // Relative (%)
            posStr = `${dec.x}% ${dec.y}%`;
        } else {
            // Absolute (px) with Anchor
            const dx = dec.x + 'px';
            const dy = dec.y + 'px';
            const anc = dec.anchor || 'tl';
            
            if (anc === 'tl') posStr = `left ${dx} top ${dy}`;
            else if (anc === 'tr') posStr = `right ${dx} top ${dy}`; // Note: user might want negative for offset out, but sliders allow neg
            else if (anc === 'bl') posStr = `left ${dx} bottom ${dy}`;
            else if (anc === 'br') posStr = `right ${dx} bottom ${dy}`;
            else if (anc === 'center') posStr = `calc(50% + ${dx}) calc(50% + ${dy})`;
        }

        if (dec.type === 'circle') {
            const sz = dec.size + 'px';
            bgImages.push(`radial-gradient(circle at ${posStr.includes('calc') || dec.posMode==='absolute' ? posStr : dec.x+'% '+dec.y+'%'}, ${hexToRgba(dec.color, op)} 0%, transparent ${sz})`);
            // Gradient syntax puts position inside.
            // For external pos:
            if(dec.posMode === 'absolute') {
                 // Complex case: Radial gradient internal positioning syntax is tricky with calc.
                 // Fallback: We use radial-gradient without position, and set background-position.
                 // BUT radial-gradient(circle, ...) centers it in the "box".
                 // Simpler: Use background-position for the gradient layer.
                 // We need to redefine the gradient string to NOT include position, and let CSS background-position handle it.
                 // However, standard radial-gradient centers in the "image box".
                 // Hack: standard radial gradient with position INSIDE is easier for browsers?
                 // Let's stick to standard background-position logic for consistency.
                 bgImages.push(`radial-gradient(closest-side, ${hexToRgba(dec.color, op)} 0%, transparent 100%)`);
            } else {
                 // Keep old logic for percent
                 bgImages.pop(); // remove prev
                 bgImages.push(`radial-gradient(circle at ${dec.x}% ${dec.y}%, ${hexToRgba(dec.color, op)} 0%, transparent ${dec.size}px)`);
                 posStr = '0 0'; // Handled inside
            }
            
            if (dec.posMode === 'absolute') {
                 bgPositions.push(posStr);
                 bgSizes.push(`${dec.size*2}px ${dec.size*2}px`); // Gradient size needs to be box size
            } else {
                 bgPositions.push('0 0');
                 bgSizes.push('100% 100%');
            }
            bgRepeats.push('no-repeat');
            clips.push("padding-box");
        } else if (dec.type === 'image' && dec.url) {
            let rawUrl = dec.url.trim().replace(/^['"]|['"]$/g, '');
            let finalUrl = !/^\s*url\s*\(/i.test(rawUrl) ? `url('${rawUrl}')` : rawUrl;

            let imgStr = finalUrl;
            if (op < 1) {
                imgStr = `-webkit-cross-fade(${finalUrl}, transparent, ${100 - op * 100}%)`;
            }
            bgImages.push(imgStr);
            bgPositions.push(posStr);
            bgSizes.push(`${dec.size}px auto`);
            bgRepeats.push('no-repeat');
            clips.push("padding-box"); 
        }
    });

    // åº•çº¹ (Skin)
    if (assets.bg !== 'none') { 
        bgImages.push(assets.bg);
        bgPositions.push('center');
        bgSizes.push('cover');
        bgRepeats.push('no-repeat');
        clips.push("padding-box"); 
    }
    
    // Base Gradient
    bgImages.push(finalGrad);
    bgPositions.push('center');
    bgSizes.push('cover');
    bgRepeats.push('no-repeat');
    clips.push("padding-box");

    // è¾¹æ¡†é€»è¾‘
    let borderVal = "", outlineVal = "", outlineOffVal = "";
    if (isGb) {
        document.getElementById('stdBorderControls').style.display = 'none';
        document.getElementById('gradBorderControls').style.display = 'flex';
        outlineVal = 'none';
    } else {
        document.getElementById('stdBorderControls').style.display = 'flex';
        document.getElementById('gradBorderControls').style.display = 'none';
        const bColor = hexToRgba(document.getElementById('borderHex').value, v('borderAlpha'));
        outlineVal = `${v('bwidth')}px ${v('borderStyle')} ${bColor}`;
        outlineOffVal = `${v('boffset')}px`;
    }

    if (isB2) {
        const b2Color = hexToRgba(document.getElementById('b2Hex').value, v('b2Alpha'));
        const b2Style = v('b2Style');
        borderVal = `${v('b2Width')}px ${b2Style} ${b2Color}`;
    } else {
        borderVal = isGb ? `${v('bwidth')}px solid transparent` : '0px solid transparent';
    }
    
    const bgImageVal = bgImages.join(', ');
    const bgPosVal = bgPositions.join(', ');
    const bgSizeVal = bgSizes.join(', ');
    const bgRepVal = bgRepeats.join(', ');
    const bgClipVal = clips.join(', ');
    const bgBlendMode = v('bgBlend'); 

    targets.forEach(t => {
        let s = t.style;
        s.borderRadius = radiusVal;
        s.boxShadow = bubbleBoxShadow;
        s.backdropFilter = `blur(${v('blur')}px)`;
        s.webkitBackdropFilter = `blur(${v('blur')}px)`;
        s.color = textColor;
        
        // 4-Way Padding
        s.padding = `${v('pt')}px ${v('pr')}px ${v('pb')}px ${v('pl')}px`;
        
        s.backgroundImage = bgImageVal;
        s.backgroundPosition = bgPosVal;
        s.backgroundSize = bgSizeVal;
        s.backgroundRepeat = bgRepVal;
        s.backgroundClip = bgClipVal;
        s.backgroundBlendMode = bgBlendMode;
        
        s.position = "relative"; 
        s.overflow = "visible"; 
        
        // å°ºå¯¸é™åˆ¶
        s.maxWidth = `${v('maxWidth')}%`;
        s.minWidth = `${v('minWidth')}px`;
        s.minHeight = `${v('minHeight')}px`;

        s.border = borderVal;
        s.outline = outlineVal;
        s.outlineOffset = outlineOffVal;

        // æ¸…é™¤æ—§è´´å›¾
        t.querySelectorAll('.p-sticker-1, .p-sticker-2, .p-gb-border').forEach(el => el.remove());

        // é¢„è§ˆæµå…‰è¾¹æ¡†
        if (isGb) {
            const gbDiv = document.createElement('div');
            gbDiv.className = 'p-gb-border';
            gbDiv.style.position = 'absolute';
            gbDiv.style.inset = '0';
            gbDiv.style.borderRadius = 'inherit';
            gbDiv.style.padding = v('bwidth') + 'px'; 
            gbDiv.style.pointerEvents = 'none';
            gbDiv.style.zIndex = '-1'; 
            
            const gbC1 = hexToRgba(document.getElementById('gh1').value, v('gbA1'));
            const gbC2 = hexToRgba(document.getElementById('gh2').value, v('gbA2'));
            const gbAngle = v('gbAngle');
            
            gbDiv.style.background = `linear-gradient(${gbAngle}deg, ${gbC1}, ${gbC2})`;
            gbDiv.style.webkitMask = 'linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0)';
            gbDiv.style.webkitMaskComposite = 'xor';
            gbDiv.style.maskComposite = 'exclude';
            
            t.appendChild(gbDiv);
        }

        // é¢„è§ˆè´´å›¾1 (After)
        if (hasSticker1 && assets.sticker1) {
            const img = document.createElement('div');
            img.className = 'p-sticker-1';
            img.style.position = 'absolute';
            img.style.width = v('sticker1Size') + 'px';
            img.style.height = v('sticker1Size') + 'px';
            img.style.backgroundImage = assets.sticker1;
            img.style.backgroundSize = 'contain';
            img.style.backgroundRepeat = 'no-repeat';
            img.style.opacity = v('sticker1Op'); 
            img.style.zIndex = '20';
            img.style.pointerEvents = 'none';

            const pos = v('sticker1Pos');
            const offX = parseFloat(v('sticker1X'));
            const offY = parseFloat(v('sticker1Y'));
            
            if(pos.includes('c')) {
                let base = 'left: 50%; top: 50%;';
                let tr = 'translate(-50%, -50%)';
                if(pos === 'tc') { base = 'left: 50%; top: 0;'; tr = 'translate(-50%, 0)'; }
                if(pos === 'bc') { base = 'left: 50%; bottom: 0;'; tr = 'translate(-50%, 0)'; }
                if(pos === 'lc') { base = 'left: 0; top: 50%;'; tr = 'translate(0, -50%)'; }
                if(pos === 'rc') { base = 'right: 0; top: 50%;'; tr = 'translate(0, -50%)'; }
                img.style.cssText += base;
                img.style.transform = `${tr} translate(${offX}px, ${offY}px)`;
            } else {
                if(pos === 'br') { img.style.right = offX + 'px'; img.style.bottom = offY + 'px'; }
                if(pos === 'bl') { img.style.left = offX + 'px'; img.style.bottom = offY + 'px'; }
                if(pos === 'tr') { img.style.right = offX + 'px'; img.style.top = offY + 'px'; }
                if(pos === 'tl') { img.style.left = offX + 'px'; img.style.top = offY + 'px'; }
            }
            t.appendChild(img);
        }

        // é¢„è§ˆè´´å›¾2 (Before)
        if (!isGb && hasSticker2 && assets.sticker2) {
            const img = document.createElement('div');
            img.className = 'p-sticker-2';
            img.style.position = 'absolute';
            img.style.width = v('sticker2Size') + 'px';
            img.style.height = v('sticker2Size') + 'px';
            img.style.backgroundImage = assets.sticker2;
            img.style.backgroundSize = 'contain';
            img.style.backgroundRepeat = 'no-repeat';
            img.style.opacity = v('sticker2Op');
            img.style.zIndex = '20';
            img.style.pointerEvents = 'none';

            const pos = v('sticker2Pos');
            const offX = parseFloat(v('sticker2X'));
            const offY = parseFloat(v('sticker2Y'));
            
            if(pos.includes('c')) {
                let base = 'left: 50%; top: 50%;';
                let tr = 'translate(-50%, -50%)';
                if(pos === 'tc') { base = 'left: 50%; top: 0;'; tr = 'translate(-50%, 0)'; }
                if(pos === 'bc') { base = 'left: 50%; bottom: 0;'; tr = 'translate(-50%, 0)'; }
                if(pos === 'lc') { base = 'left: 0; top: 50%;'; tr = 'translate(0, -50%)'; }
                if(pos === 'rc') { base = 'right: 0; top: 50%;'; tr = 'translate(0, -50%)'; }
                img.style.cssText += base;
                img.style.transform = `${tr} translate(${offX}px, ${offY}px)`;
            } else {
                if(pos === 'br') { img.style.right = offX + 'px'; img.style.bottom = offY + 'px'; }
                if(pos === 'bl') { img.style.left = offX + 'px'; img.style.bottom = offY + 'px'; }
                if(pos === 'tr') { img.style.right = offX + 'px'; img.style.top = offY + 'px'; }
                if(pos === 'tl') { img.style.left = offX + 'px'; img.style.top = offY + 'px'; }
            }
            t.appendChild(img);
        }
    });

    const sel = v('selectorType');
    let selector = ".message-bubble";
    if (sel === 'sent') selector = ".message-container.sent .message-bubble";
    if (sel === 'received') selector = ".message-container.received .message-bubble";

    let css = `${selector} {
  /* åŸºç¡€å®šä½ä¸é˜²é”™ä½ */
  position: relative !important;
  overflow: visible !important;
  box-sizing: border-box !important;
  padding: ${v('pt')}px ${v('pr')}px ${v('pb')}px ${v('pl')}px !important;
  border-radius: ${radiusVal} !important;
  
  /* å°ºå¯¸é™åˆ¶ */
  max-width: ${v('maxWidth')}% !important;
  min-width: ${v('minWidth')}px !important;
  min-height: ${v('minHeight')}px !important;
  
  /* æ¸…é™¤åº•è‰² */
  background-color: transparent !important;
  
  /* èƒŒæ™¯å±‚ (å«è£…é¥°+åº•çº¹) */
  background-image: ${bgImageVal} !important;
  background-position: ${bgPosVal} !important;
  background-size: ${bgSizeVal} !important;
  background-repeat: ${bgRepVal} !important;
  background-clip: ${bgClipVal} !important;
  background-blend-mode: ${bgBlendMode} !important;
  
  /* é˜´å½±ä¸è´¨æ„Ÿ */
  box-shadow: ${bubbleBoxShadow} !important;
  color: ${textColor} !important;
  backdrop-filter: blur(${v('blur')}px) !important;
  -webkit-backdrop-filter: blur(${v('blur')}px) !important;
  
  line-height: 1.55 !important;
  letter-spacing: 0.02em !important;
  word-break: break-word !important;
  z-index: 10 !important;
`;

    if (isGb) {
        css += `  border: ${borderVal} !important;\n  outline: none !important;\n}`;
        const gbC1 = hexToRgba(document.getElementById('gh1').value, v('gbA1'));
        const gbC2 = hexToRgba(document.getElementById('gh2').value, v('gbA2'));
        const gbAngle = v('gbAngle');
        
        css += `\n\n/* æµå…‰è¾¹æ¡† (å ç”¨ ::before) */
${selector}::before {
  content: '' !important;
  position: absolute !important;
  inset: 0 !important;
  border-radius: inherit !important;
  padding: ${v('bwidth')}px !important;
  background: linear-gradient(${gbAngle}deg, ${gbC1}, ${gbC2}) !important;
  -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0) !important;
  -webkit-mask-composite: xor !important;
  mask-composite: exclude !important;
  pointer-events: none !important;
  z-index: -1 !important;
}`;
    } else {
        css += `  border: ${borderVal} !important;
  outline: ${outlineVal} !important;
  outline-offset: ${outlineOffVal} !important;\n}`;
    }

    if (hasSticker1 && assets.sticker1) {
        const sSize = v('sticker1Size');
        const sPos = v('sticker1Pos');
        const sX = v('sticker1X'); 
        const sY = v('sticker1Y');
        const sOp = v('sticker1Op');
        
        let posCss = '';
        if(sPos.includes('c')) {
            let base = 'left: 50%; top: 50%;';
            let tr = 'translate(-50%, -50%)';
            if(sPos === 'tc') { base = 'left: 50%; top: 0;'; tr = 'translate(-50%, 0)'; }
            if(sPos === 'bc') { base = 'left: 50%; bottom: 0;'; tr = 'translate(-50%, 0)'; }
            if(sPos === 'lc') { base = 'left: 0; top: 50%;'; tr = 'translate(0, -50%)'; }
            if(sPos === 'rc') { base = 'right: 0; top: 50%;'; tr = 'translate(0, -50%)'; }
            posCss = `${base} transform: ${tr} translate(${sX}px, ${sY}px);`;
        } else {
            if(sPos === 'br') posCss = `right: ${sX}px; bottom: ${sY}px;`;
            if(sPos === 'bl') posCss = `left: ${sX}px; bottom: ${sY}px;`;
            if(sPos === 'tr') posCss = `right: ${sX}px; top: ${sY}px;`;
            if(sPos === 'tl') posCss = `left: ${sX}px; top: ${sY}px;`;
        }

        css += `\n\n/* è´´å›¾ 1 (After) */
${selector}::after {
  content: '' !important;
  position: absolute !important;
  width: ${sSize}px !important;
  height: ${sSize}px !important;
  background-image: ${assets.sticker1} !important;
  background-size: contain !important;
  background-repeat: no-repeat !important;
  opacity: ${sOp} !important;
  ${posCss}
  z-index: 20 !important;
  pointer-events: none !important;
}`;
    }

    if (!isGb && hasSticker2 && assets.sticker2) {
         const sSize = v('sticker2Size');
        const sPos = v('sticker2Pos');
        const sX = v('sticker2X'); 
        const sY = v('sticker2Y');
        const sOp = v('sticker2Op');
        
        let posCss = '';
        if(sPos.includes('c')) {
            let base = 'left: 50%; top: 50%;';
            let tr = 'translate(-50%, -50%)';
            if(sPos === 'tc') { base = 'left: 50%; top: 0;'; tr = 'translate(-50%, 0)'; }
            if(sPos === 'bc') { base = 'left: 50%; bottom: 0;'; tr = 'translate(-50%, 0)'; }
            if(sPos === 'lc') { base = 'left: 0; top: 50%;'; tr = 'translate(0, -50%)'; }
            if(sPos === 'rc') { base = 'right: 0; top: 50%;'; tr = 'translate(0, -50%)'; }
            posCss = `${base} transform: ${tr} translate(${sX}px, ${sY}px);`;
        } else {
            if(sPos === 'br') posCss = `right: ${sX}px; bottom: ${sY}px;`;
            if(sPos === 'bl') posCss = `left: ${sX}px; bottom: ${sY}px;`;
            if(sPos === 'tr') posCss = `right: ${sX}px; top: ${sY}px;`;
            if(sPos === 'tl') posCss = `left: ${sX}px; top: ${sY}px;`;
        }

        css += `\n\n/* è´´å›¾ 2 (Before) */
${selector}::before {
  content: '' !important;
  position: absolute !important;
  width: ${sSize}px !important;
  height: ${sSize}px !important;
  background-image: ${assets.sticker2} !important;
  background-size: contain !important;
  background-repeat: no-repeat !important;
  opacity: ${sOp} !important;
  ${posCss}
  z-index: 20 !important;
  pointer-events: none !important;
  border: none !important; 
  background-color: transparent !important; 
}`;
    }

    codeOut.innerText = css;
}

// æ–°å¢ï¼šæ¸²æŸ“é“¾æ¥ä¿®å¤é¢æ¿
function renderUrlFixPanel() {
    const panel = document.getElementById('urlFixPanel');
    const list = document.getElementById('urlFixList');
    list.innerHTML = '';
    
    let hasImages = false;

    // 1. æ£€æŸ¥èƒŒæ™¯å›¾
    if(assets.bg && assets.bg !== 'none') {
        hasImages = true;
        addUrlInput(list, 'åº•çº¹èƒŒæ™¯ (Skin)', assets.bg, (val) => {
             assets.bg = formatUrl(val);
             update();
        });
    }

    // 2. æ£€æŸ¥è´´å›¾1
    if(document.getElementById('sticker1Switch').checked && assets.sticker1) {
        hasImages = true;
        addUrlInput(list, 'è´´å›¾ 1 (Sticker)', assets.sticker1, (val) => {
             assets.sticker1 = formatUrl(val);
             update();
        });
    }

    // 3. æ£€æŸ¥è´´å›¾2
    if(document.getElementById('sticker2Switch').checked && assets.sticker2 && !document.getElementById('gradBorderSwitch').checked) {
        hasImages = true;
        addUrlInput(list, 'è´´å›¾ 2 (Aux)', assets.sticker2, (val) => {
             assets.sticker2 = formatUrl(val);
             update();
        });
    }

    // 4. æ£€æŸ¥è£…é¥°å±‚
    decorations.forEach((d, i) => {
        if(d.type === 'image') {
            hasImages = true;
            addUrlInput(list, `è£…é¥°å±‚ ${i+1} (Deco)`, d.url, (val) => {
                d.url = val; // è£…é¥°å±‚é€»è¾‘ç‰¹æ®Šï¼Œè¿™é‡Œå­˜åŸå§‹å€¼ï¼Œupdateé‡Œä¼šå¤„ç†url()åŒ…è£¹
                renderDecorationList(); // åŒæ­¥æ›´æ–°UIåˆ—è¡¨
                update();
            });
        }
    });

    panel.style.display = hasImages ? 'block' : 'none';
}

function addUrlInput(container, label, currentVal, onChange) {
    // æå–çº¯å‡€URLç”¨äºæ˜¾ç¤º (å»é™¤ url('...'))
    let displayVal = currentVal.replace(/^url\(['"]?/, '').replace(/['"]?\)$/, '');
    
    const row = document.createElement('div');
    row.style.display = 'flex';
    row.style.alignItems = 'center';
    row.style.gap = '8px';
    
    row.innerHTML = `
        <span style="font-size:11px; color:#666; width:90px; flex-shrink:0;">${label}</span>
        <input type="text" value="${displayVal}" 
            style="flex:1; padding:6px; border:1px solid #ddd; border-radius:4px; font-size:11px; font-family:'Menlo',monospace;"
            onchange="this.style.borderColor='#34c759';">
    `;
    
    const input = row.querySelector('input');
    input.oninput = (e) => {
        onChange(e.target.value);
    };
    
    container.appendChild(row);
}

// è¾…åŠ©ï¼šç»Ÿä¸€æ ¼å¼åŒ–ä¸º url(...)
function formatUrl(val) {
    if(!val) return '';
    let raw = val.trim();
    if(raw.startsWith('url')) return raw;
    return `url('${raw}')`;
}

window.addEventListener('load', () => {
    const savedCanvas = localStorage.getItem('eve_canvas_mode_final');
    if(savedCanvas) setCanvas(savedCanvas);
    if (!loadState()) { applyPreset('classic'); } else { update(); }
    setTimeout(update, 100); 
});
</script>
</body>
</html>
